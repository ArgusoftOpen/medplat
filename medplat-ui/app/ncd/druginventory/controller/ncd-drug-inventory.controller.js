(function (angular) {
    function NcdDrugInventoryController(NcdDAO, Mask, toaster, GeneralUtil, AuthenticateService, QueryDAO, $q) {
        var ncddi = this;
        ncddi.appName = GeneralUtil.getAppName();
        ncddi.DrugReceivedDto = {};
        ncddi.DrugIssuedDto = {};
        ncddi.DrugIssuedDto.durations = 'TM';
        ncddi.DrugReceivedDto.duration = 'TM';
        ncddi.today = new Date();
        ncddi.minDate = moment(ncddi.today).subtract(1, 'months');

        var init = function () {
            ncddi.isUserHealthFetch = false
            AuthenticateService.getLoggedInUser().then(function (res) {
                ncddi.loggedInUser = res.data;
                // ncddi.retrievelog(res.data.id)
                ncddi.retrieveLoggedInUserHealthInfra(res.data.id);
            })
            ncddi.retriveDrugList();
        };

        ncddi.onTabChange = (status) => {
            ncddi.drugAllDrugInventory = [];
            ncddi.DrugIssuedDto.durations = 'TM';
            ncddi.DrugReceivedDto.duration = 'TM';
            if (status) {
                if (ncddi.DrugReceivedDto.parentHealthId) {
                    ncddi.retriveAllDrugInventory(ncddi.DrugReceivedDto.parentHealthId, 'TM');
                }
                ncddi.DrugReceivedDto.isReceived = true;
                ncddi.DrugReceivedDto.isIssued = false;
            } else {
                if (ncddi.DrugIssuedDto.child) {
                    ncddi.retriveAllDrugInventory(ncddi.DrugIssuedDto.child, 'TM');
                }
                ncddi.DrugIssuedDto.isReceived = false;
                ncddi.DrugIssuedDto.isIssued = true;
            }
        }

        ncddi.retrieveLoggedInUserHealthInfra = function (userId) {
            if (userId) {
                QueryDAO.execute({
                    code: 'retrieve_health_infra_for_user',
                    parameters: {
                        userId: userId
                    }
                }).then(function (res) {
                    ncddi.isUserHealthFetch = true
                    ncddi.userHealthInfras = res.result;
                })
            }
        };

        ncddi.retriveDrugList = function () {
            Mask.show();
            NcdDAO.retriveDrugList().then(function (res) {
                ncddi.drugList = res;
            }, GeneralUtil.showMessageOnApiCallFailure).finally(function () {
                Mask.hide();
            });

        };

        ncddi.retrieveDrugReceivedByInfraId = function (healthId) {
            Mask.show();
            NcdDAO.retrieveDrugReceivedByInfraId(healthId).then(function (res) {
                ncddi.drugAllMedicines = res;
            }, GeneralUtil.showMessageOnApiCallFailure).finally(function () {
                Mask.hide();
            });
        };

        ncddi.onParentHealthInfraChange = function () {
            ncddi.retriveAllDrugInventory(ncddi.DrugReceivedDto.parentHealthId, 'TM');
            ncddi.retrieveDrugReceivedByInfraId(ncddi.DrugReceivedDto.parentHealthId);
            ncddi.retrieveChildHealthInfraByParentId(ncddi.DrugReceivedDto.parentHealthId)
        };

        ncddi.onChildInfraChange = function () {
            ncddi.retriveAllDrugInventory(ncddi.DrugIssuedDto.child, 'TM');
        }

        ncddi.retrieveChildHealthInfraByParentId = function (healthId) {
            Mask.show();
            NcdDAO.retrieveChildHealthInfraByParentId(healthId).then(function (res) {
                ncddi.childInfras = res;
            }, GeneralUtil.showMessageOnApiCallFailure).finally(function () {
                Mask.hide();
            });
        }

        ncddi.retriveAllDrugInventory = function (healthId, duration) {
            NcdDAO.retriveAllDrugInventory(healthId, duration).then(function (res) {
                ncddi.drugAllDrugInventory = res;
            })
        };



        ncddi.printDISummary = function () {
            //var header = "<div class='print_header display-none'><img class='print_logo' src=\"img/techo_plus.png\" ><h2 class='page_title'>" + "Drug Innventory Records " + "</h2></div>";
            var header = "<div class='print_header display-none'><h2 class='page_title'>" + "Drug Innventory Records " + "</h2></div>";
            ncddi.footer = "Generated by " + ncddi.loggedInUser.name + " at " + new Date().toLocaleString();
            let promiseList = [];
            promiseList.push(ncddi.drugAllDrugInventory);
            $q.all(promiseList).then(function (res) {
                $('#printableDi').printThis({
                    debug: false,
                    importCSS: false,
                    loadCSS: ['styles/css/printable.css', 'styles/css/ncd_printable.css'],
                    header: header,
                    printDelay: 333,
                    base: "./",
                    pageTitle: ncddi.appName
                });
            })
        };

        ncddi.saveDrugIssued = function (isReturn) {
            ncddi.drugIssuedForm.$setSubmitted();
            if (ncddi.drugIssuedForm.$valid) {
                ncddi.DrugIssuedDto.isReturn = isReturn;
                ncddi.DrugIssuedDto.healthInfraId = ncddi.DrugIssuedDto.child;
                ncddi.DrugIssuedDto.parentHealthId = ncddi.DrugReceivedDto.parentHealthId;

                if (ncddi.DrugIssuedDto.quantityReceived == null) {
                    ncddi.DrugIssuedDto.quantityReceived = 0;
                } else if (ncddi.DrugIssuedDto.quantityIssued == null) {
                    ncddi.DrugIssuedDto.quantityIssued = 0;
                }


                NcdDAO.saveDrugInventory(ncddi.DrugIssuedDto).then(function () {
                    if (ncddi.DrugIssuedDto.isuued) {
                        toaster.pop('success', "Drug Return Details saved successfully");
                    } else {
                        toaster.pop('success', "Drug Issued Details saved successfully");
                    }
                    ncddi.retriveAllDrugInventory(ncddi.DrugIssuedDto.healthInfraId, ncddi.DrugIssuedDto.durations);
                    ncddi.clearDrugIssuedForm();
                    ncddi.drugIssuedForm.$setPristine();
                }, GeneralUtil.showMessageOnApiCallFailure)
            }
        };

        ncddi.clearDrugIssuedForm = () => {
            ncddi.DrugIssuedDto.medicineId = null;
            ncddi.DrugIssuedDto.quantityReceived = 0;
            ncddi.DrugIssuedDto.issuedDate = null;
            ncddi.DrugIssuedDto.isReturn = null;
        };

        ncddi.clearDrugReceivedForm = () => {
            ncddi.DrugReceivedDto.medicineId = null;
            ncddi.DrugReceivedDto.quantityReceived = 0;
            ncddi.DrugReceivedDto.issuedDate = null;
        }

        ncddi.saveDrugReceived = function () {
            ncddi.drugReceivedForm.$setSubmitted();
            if (ncddi.drugReceivedForm.$valid) {
                ncddi.DrugReceivedDto.healthInfraId = ncddi.DrugReceivedDto.parentHealthId;

                if (ncddi.DrugReceivedDto.quantityReceived == null) {
                    ncddi.DrugReceivedDto.quantityReceived = 0;
                } else if (ncddi.DrugReceivedDto.quantityIssued == null) {
                    ncddi.DrugReceivedDto.quantityIssued = 0;
                }

                NcdDAO.saveDrugInventory(ncddi.DrugReceivedDto).then(function () {
                    toaster.pop('success', "Drug Received Details saved successfully");
                    ncddi.retrieveDrugReceivedByInfraId(ncddi.DrugReceivedDto.healthInfraId);
                    ncddi.retriveAllDrugInventory(ncddi.DrugReceivedDto.healthInfraId, ncddi.DrugReceivedDto.duration);
                    ncddi.drugReceivedForm.$setPristine();
                    ncddi.clearDrugReceivedForm();
                }, GeneralUtil.showMessageOnApiCallFailure)
            }
        };

        init();
    }
    angular.module('imtecho.controllers').controller('NcdDrugInventoryController', NcdDrugInventoryController);
})(window.angular);