
(function () {
    function FhsReportController($stateParams, $state, DataPersistService, $window, QueryDAO, GeneralUtil) {
        var ctrl = this;
        ctrl.appName = GeneralUtil.getAppName();
        ctrl.ashaLists = [];
        var locationId = $stateParams.locationId;
        ctrl.locationId = locationId;
        ctrl.isFHSreportloaded = false;
        ctrl.personList = function () {
            var queryDto = {
                code: "fhs_dashboard_userwise_list",
                parameters: {
                    userId: Number($stateParams.userId),
                    locationId: Number(locationId)
                }
            }
            QueryDAO.execute(queryDto).then(function (res) {
                ctrl.ashaLists = res.result;
                for (let i = 0; i < ctrl.ashaLists.length; i++) {
                    if (ctrl.ashaLists[i].value == null || ctrl.ashaLists[i].value == undefined)
                        ctrl.ashaLists[i].value = "N/A";
                }
                ctrl.excelData = ctrl.ashaLists;
                ctrl.items = [];
                for (let i = 0; i < ctrl.excelData.length; i++) {
                    var memberDetails = ctrl.excelData[i];
                    var excelObj = {
                        "#": (i + 1),
                        "Person": memberDetails.personName,
                        // "Imported From eMamta": memberDetails.importedFromEmamta,
                        "To be processed": memberDetails.unverifiedFHS,
                        "In Reverification": memberDetails.inReverification,
                        "Verified": memberDetails.verifiedFHS,
                        "Archived": memberDetails.archivedFHS,
                        "New Families Added": memberDetails.newFamily,
                        [`Total Families in ${ctrl.appName}`]: memberDetails.newFamily + memberDetails.verifiedFHS,
                        [`Total Members in ${ctrl.appName}`]: memberDetails.totalMember
                    };
                    ctrl.items.push(excelObj);
                }
                for (let i = 0; i < ctrl.ashaLists.length; i++) {
                    if (ctrl.ashaLists[i].value == null)
                        ctrl.ashaLists[i].value = "N/A";
                }
                ctrl.isFHSreportloaded = true;
            }).catch(function (e) {
                ctrl.isFHSreportloaded = true;
            });
        };

        ctrl.checkIfRefresh = function () {
            if (!DataPersistService.getData()) {
                $state.go('techo.dashboard.fhs');
            }
        };

        ctrl.checkIfRefresh();

        ctrl.navigateToFhsDashboard = function () {
            $state.go('techo.dashboard.fhs');
        };

        //excel creation
        ctrl.saveExcel = function () {
            var mystyle = {
                headers: true,
                column: { style: { Font: { Bold: "1" } } }
            };
            alasql('SELECT * INTO XLSX("FAMILY HEALTH DETAIL REPORT",?) FROM ?', [mystyle, ctrl.items]);
        };

        //print option for fhs report option
        ctrl.printPdf = function () {
            var header = "<h2>" + "FAMILY HEALTH SURVEY REPORT" + "</h2>";
            var selectedId = "#fhsreport-table";
            ctrl.footer = "Generated by " + $window.localStorage.getItem("username") + " at " + new Date().toLocaleString();
            $(selectedId).printThis({
                importCSS: false,
                loadCSS: 'styles/css/printable.css',
                header: header,
                base: "./",
                pageTitle: ctrl.appName
            });
        };

        ctrl.personList();
    }

    angular.module('imtecho.controllers').controller('FhsReportController', FhsReportController);
})();
